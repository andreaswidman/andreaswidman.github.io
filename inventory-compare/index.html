<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Inventory Compare</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: hsl(0 0% 100%);
      --fg: hsl(222 47% 11%);
      --muted: hsl(220 9% 46%);
      --muted-fg: hsl(220 9% 46%);
      --border: hsl(220 13% 91%);
      --input: hsl(220 13% 91%);
      --ring: hsl(222 47% 11%);
      --radius: 0.375rem;
      --radius-lg: 0.5rem;
      --green-bg: hsl(142 72% 94%);
      --green-fg: hsl(142 72% 29%);
      --red-bg: hsl(0 84% 95%);
      --red-fg: hsl(0 84% 37%);
      --blue-bg: hsl(217 91% 95%);
      --blue-fg: hsl(217 91% 40%);
      --orange-bg: hsl(38 92% 95%);
      --orange-fg: hsl(38 92% 35%);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      color: var(--fg);
      background: var(--bg);
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem; }
    h1 { font-size: 1.5rem; font-weight: 600; margin-bottom: 0.25rem; }
    .subtitle { color: var(--muted); font-size: 0.875rem; margin-bottom: 2rem; }

    .input-zones { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      text-align: center;
      transition: border-color 0.15s, background 0.15s;
      cursor: pointer;
      position: relative;
    }
    .drop-zone.dragover { border-color: var(--ring); background: hsl(220 13% 97%); }
    .drop-zone.loaded { border-style: solid; border-color: hsl(142 72% 60%); }
    .drop-zone h2 { font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem; }
    .drop-zone p { color: var(--muted); font-size: 0.8125rem; }
    .drop-zone input[type="file"] {
      position: absolute; inset: 0; opacity: 0; cursor: pointer;
    }
    .file-list { margin-top: 0.75rem; text-align: left; }
    .file-item {
      font-size: 0.8125rem; color: var(--muted);
      padding: 0.2rem 0; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between;
    }
    .file-item .count { font-weight: 500; color: var(--fg); }
    .file-item.error { color: var(--red-fg); }

    .actions { margin-bottom: 1.5rem; }
    button {
      display: inline-flex; align-items: center; justify-content: center;
      height: 2.25rem; padding: 0 1rem;
      font-size: 0.875rem; font-weight: 500;
      border-radius: var(--radius);
      border: 1px solid transparent;
      cursor: pointer;
      transition: opacity 0.15s;
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--fg); color: var(--bg); }
    .btn-primary:hover:not(:disabled) { opacity: 0.9; }
    .btn-ghost {
      background: transparent; color: var(--fg);
      border-color: var(--border);
    }
    .btn-ghost:hover:not(:disabled) { background: hsl(220 13% 97%); }

    .filters {
      position: sticky; top: 0; z-index: 10;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 0;
      margin-bottom: 0;
      display: none;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    .filters.visible { display: flex; }
    .filters label { font-size: 0.8125rem; font-weight: 500; color: var(--muted); margin-right: 0.25rem; }
    .filters select, .filters input[type="text"] {
      height: 2.25rem;
      padding: 0 0.75rem;
      font-size: 0.8125rem;
      border: 1px solid var(--input);
      border-radius: var(--radius);
      background: var(--bg);
      color: var(--fg);
      outline: none;
    }
    .filters select:focus, .filters input[type="text"]:focus {
      outline: 2px solid var(--ring);
      outline-offset: -1px;
    }
    .filters input[type="text"] { width: 200px; }
    .filter-group { display: flex; align-items: center; gap: 0.25rem; }
    .summary {
      font-size: 0.8125rem; color: var(--muted);
      margin-left: auto;
      white-space: nowrap;
    }

    .table-wrapper { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
    thead th {
      text-align: left; padding: 0.625rem 0.75rem;
      font-weight: 500; color: var(--muted);
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }
    thead th:hover { color: var(--fg); }
    thead th .sort-arrow { margin-left: 0.25rem; font-size: 0.75rem; }
    tbody td {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--border);
    }
    tbody tr:last-child td { border-bottom: none; }
    td.num { text-align: right; font-variant-numeric: tabular-nums; }

    tr.row-increased { background: var(--green-bg); }
    tr.row-decreased { background: var(--red-bg); }
    tr.row-added { background: var(--blue-bg); }
    tr.row-removed { background: var(--orange-bg); }

    .badge {
      display: inline-block;
      font-size: 0.6875rem;
      font-weight: 600;
      padding: 0.125rem 0.375rem;
      border-radius: 9999px;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    .badge-new { background: var(--blue-bg); color: var(--blue-fg); }
    .badge-removed { background: var(--orange-bg); color: var(--orange-fg); }
    .badge-up { color: var(--green-fg); }
    .badge-down { color: var(--red-fg); }

    .empty-state {
      text-align: center; padding: 3rem 1rem;
      color: var(--muted); font-size: 0.875rem;
    }

    #resultsSection { display: none; }
    #resultsSection.visible { display: block; }

    #toaster {
      position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%);
      z-index: 100; display: flex; flex-direction: column; gap: 0.5rem; align-items: center;
    }
    .toast {
      background: var(--fg); color: var(--bg);
      border: none;
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15), 0 1px 3px rgba(0,0,0,0.08);
      padding: 0.75rem 1rem;
      font-size: 0.8125rem;
      display: flex; align-items: center; gap: 0.75rem;
      min-width: 300px; max-width: 420px;
      animation: toast-in 0.2s ease-out;
    }
    .toast.removing { animation: toast-out 0.15s ease-in forwards; }
    .toast-msg { flex: 1; }
    .toast-close {
      background: none; border: none; padding: 0; height: auto;
      color: hsl(220 13% 70%); cursor: pointer; font-size: 1rem; line-height: 1;
    }
    .toast-close:hover { color: var(--bg); }
    @keyframes toast-in { from { opacity: 0; transform: translateY(0.5rem); } to { opacity: 1; transform: translateY(0); } }
    @keyframes toast-out { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(0.5rem); } }
  </style>
</head>
<body>
  <div class="container">
    <h1>Inventory Compare</h1>
    <p class="subtitle">Compare allocation values across SFCC inventory XML exports</p>

    <div class="input-zones">
      <div class="drop-zone" id="oldZone">
        <input type="file" id="oldFiles" webkitdirectory>
        <h2>Old Inventory Files</h2>
        <p>Click or drop a folder of .xml files</p>
        <div class="file-list" id="oldFileList"></div>
      </div>
      <div class="drop-zone" id="newZone">
        <input type="file" id="newFiles" webkitdirectory>
        <h2>New Inventory Files</h2>
        <p>Click or drop a folder of .xml files</p>
        <div class="file-list" id="newFileList"></div>
      </div>
    </div>

    <div class="actions">
      <button class="btn-primary" id="compareBtn" disabled>Compare</button>
    </div>

    <div id="resultsSection">
      <div class="filters" id="filters">
        <div class="filter-group">
          <label for="filterListId">List ID</label>
          <select id="filterListId"><option value="all">All</option></select>
        </div>
        <div class="filter-group">
          <label for="filterSku">Product ID</label>
          <input type="text" id="filterSku" placeholder="Search...">
        </div>
        <div class="filter-group">
          <label for="filterInNew">In New</label>
          <select id="filterInNew">
            <option value="all">All</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filterHasDiff">Has Diff</label>
          <select id="filterHasDiff">
            <option value="all">All</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>
        <button class="btn-ghost" id="exportCsv">Export CSV</button>
        <span class="summary" id="summary"></span>
      </div>

      <div class="table-wrapper">
        <table id="resultsTable">
          <thead>
            <tr>
              <th data-col="listId">List ID <span class="sort-arrow"></span></th>
              <th data-col="productId">Product ID <span class="sort-arrow"></span></th>
              <th data-col="oldAlloc">Old Allocation <span class="sort-arrow"></span></th>
              <th data-col="newAlloc">New Allocation <span class="sort-arrow"></span></th>
              <th data-col="diff">Diff <span class="sort-arrow"></span></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="empty-state" id="emptyState" style="display:none">No rows match your filters.</div>
    </div>
  </div>

  <script>
    const NS = 'http://www.demandware.com/xml/impex/inventory/2007-05-31';

    const oldData = new Map();
    const newData = new Map();
    let comparedRows = [];
    let filteredRows = [];
    let sortState = { column: 'listId', direction: 'asc' };

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);

    // File reading
    function readFilesFromInput(input) {
      const files = Array.from(input.files).filter(f => f.name.endsWith('.xml'));
      return files;
    }

    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(new Error('Failed to read ' + file.name));
        reader.readAsText(file);
      });
    }

    function parseInventoryXML(xmlText) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(xmlText, 'application/xml');
      const parseError = doc.querySelector('parsererror');
      if (parseError) throw new Error(parseError.textContent);

      const lists = doc.getElementsByTagNameNS(NS, 'inventory-list');
      const results = [];

      for (const list of lists) {
        const header = list.getElementsByTagNameNS(NS, 'header')[0];
        if (!header) continue;
        const listId = header.getAttribute('list-id');
        const records = list.getElementsByTagNameNS(NS, 'record');

        for (const record of records) {
          const productId = record.getAttribute('product-id');
          const allocElem = record.getElementsByTagNameNS(NS, 'allocation')[0];
          const allocation = allocElem ? (parseInt(allocElem.textContent, 10) || 0) : 0;
          results.push({ listId, productId, allocation });
        }
      }
      return results;
    }

    function escapeHTML(str) {
      const el = document.createElement('span');
      el.textContent = str;
      return el.innerHTML;
    }

    async function handleFiles(input, dataMap, fileListEl, zoneEl) {
      dataMap.clear();
      fileListEl.innerHTML = '';

      const allFiles = Array.from(input.files);
      const xmlFiles = allFiles.filter(f => f.name.endsWith('.xml'));
      const gzFiles = allFiles.filter(f => f.name.endsWith('.gz'));

      if (gzFiles.length > 0) {
        showToast('Gzipped files detected \u2014 please decompress before loading');
      }

      let totalRecords = 0;
      for (const file of xmlFiles) {
        const item = document.createElement('div');
        item.className = 'file-item';
        try {
          const text = await readFileAsText(file);
          const records = parseInventoryXML(text);
          for (const r of records) {
            const key = r.listId + '|||' + r.productId;
            if (dataMap.has(key)) {
              console.warn('Duplicate key in', file.name, ':', key);
            }
            dataMap.set(key, r);
          }
          totalRecords += records.length;
          item.innerHTML = '<span>' + escapeHTML(file.name) + '</span><span class="count">' + records.length + ' records</span>';
        } catch (e) {
          item.className = 'file-item error';
          item.textContent = file.name + ' â€” parse error';
          console.error(e);
        }
        fileListEl.appendChild(item);
      }

      zoneEl.classList.toggle('loaded', dataMap.size > 0);
      updateCompareButton();
    }

    function updateCompareButton() {
      $('#compareBtn').disabled = !(oldData.size > 0 && newData.size > 0);
    }

    // Comparison
    function compareInventories() {
      const allKeys = new Set([...oldData.keys(), ...newData.keys()]);
      comparedRows = [];

      for (const key of allKeys) {
        const old = oldData.get(key);
        const nw = newData.get(key);
        const listId = (old || nw).listId;
        const productId = (old || nw).productId;
        const oldAlloc = old ? old.allocation : null;
        const newAlloc = nw ? nw.allocation : null;
        let diff = null;
        if (oldAlloc !== null && newAlloc !== null) {
          diff = newAlloc - oldAlloc;
        }

        comparedRows.push({
          listId,
          productId,
          oldAlloc,
          newAlloc,
          diff,
          inOld: old !== undefined,
          inNew: nw !== undefined,
          hasDiff: oldAlloc !== newAlloc,
        });
      }

      populateListIdFilter();
      applyFilters();

      $('#resultsSection').classList.add('visible');
      $('#filters').classList.add('visible');
    }

    function populateListIdFilter() {
      const select = $('#filterListId');
      const ids = new Set(comparedRows.map(r => r.listId));
      select.innerHTML = '<option value="all">All</option>';
      for (const id of [...ids].sort()) {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = id;
        select.appendChild(opt);
      }
    }

    // Filtering
    function applyFilters() {
      const listIdFilter = $('#filterListId').value;
      const skuFilter = $('#filterSku').value.trim().toLowerCase();
      const inNewFilter = $('#filterInNew').value;
      const hasDiffFilter = $('#filterHasDiff').value;

      filteredRows = comparedRows.filter(row => {
        if (listIdFilter !== 'all' && row.listId !== listIdFilter) return false;
        if (skuFilter && !row.productId.toLowerCase().includes(skuFilter)) return false;
        if (inNewFilter === 'yes' && !row.inNew) return false;
        if (inNewFilter === 'no' && row.inNew) return false;
        if (hasDiffFilter === 'yes' && !row.hasDiff) return false;
        if (hasDiffFilter === 'no' && row.hasDiff) return false;
        return true;
      });

      applySorting(filteredRows);
      renderTable(filteredRows);
      updateSummary();
    }

    // Sorting
    function applySorting(rows) {
      rows.sort((a, b) => {
        let valA = a[sortState.column];
        let valB = b[sortState.column];

        if (valA === null && valB === null) return 0;
        if (valA === null) return 1;
        if (valB === null) return -1;

        if (typeof valA === 'string') {
          const cmp = valA.localeCompare(valB);
          return sortState.direction === 'asc' ? cmp : -cmp;
        }
        return sortState.direction === 'asc' ? valA - valB : valB - valA;
      });
    }

    function handleSort(col) {
      if (sortState.column === col) {
        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
      } else {
        sortState.column = col;
        sortState.direction = 'asc';
      }
      updateSortArrows();
      applyFilters();
    }

    function updateSortArrows() {
      $$('thead th').forEach(th => {
        const arrow = th.querySelector('.sort-arrow');
        const col = th.dataset.col;
        if (col === sortState.column) {
          arrow.textContent = sortState.direction === 'asc' ? '\u25B2' : '\u25BC';
        } else {
          arrow.textContent = '';
        }
      });
    }

    // Rendering
    function getRowClass(row) {
      if (!row.inOld) return 'row-added';
      if (!row.inNew) return 'row-removed';
      if (row.diff > 0) return 'row-increased';
      if (row.diff < 0) return 'row-decreased';
      return '';
    }

    function formatDiff(row) {
      if (!row.inOld) return '<span class="badge badge-new">New</span>';
      if (!row.inNew) return '<span class="badge badge-removed">Removed</span>';
      if (row.diff === 0) return '0';
      if (row.diff > 0) return '<span class="badge-up">+' + row.diff + '</span>';
      return '<span class="badge-down">' + row.diff + '</span>';
    }

    function renderTable(rows) {
      const tbody = $('#tbody');
      const empty = $('#emptyState');

      if (rows.length === 0) {
        tbody.innerHTML = '';
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      const fragment = document.createDocumentFragment();
      for (const row of rows) {
        const tr = document.createElement('tr');
        tr.className = getRowClass(row);
        tr.innerHTML =
          '<td>' + escapeHTML(row.listId) + '</td>' +
          '<td>' + escapeHTML(row.productId) + '</td>' +
          '<td class="num">' + (row.oldAlloc !== null ? row.oldAlloc : '--') + '</td>' +
          '<td class="num">' + (row.newAlloc !== null ? row.newAlloc : '--') + '</td>' +
          '<td class="num">' + formatDiff(row) + '</td>';
        fragment.appendChild(tr);
      }

      tbody.innerHTML = '';
      tbody.appendChild(fragment);
    }

    function updateSummary() {
      const total = comparedRows.length;
      const shown = filteredRows.length;
      const changed = comparedRows.filter(r => r.inOld && r.inNew && r.diff !== 0).length;
      const added = comparedRows.filter(r => !r.inOld).length;
      const removed = comparedRows.filter(r => !r.inNew).length;
      $('#summary').textContent =
        'Showing ' + shown + ' of ' + total + ' rows \u2014 ' +
        changed + ' changed, ' + added + ' added, ' + removed + ' removed';
    }

    // CSV Export
    function exportCSV() {
      const header = 'List ID,Product ID,Old Allocation,New Allocation,Diff\n';
      const lines = filteredRows.map(row => {
        const diffVal = (!row.inOld) ? 'NEW' :
                        (!row.inNew) ? 'REMOVED' :
                        row.diff;
        return [
          '"' + row.listId + '"',
          '"' + row.productId + '"',
          row.oldAlloc !== null ? row.oldAlloc : '',
          row.newAlloc !== null ? row.newAlloc : '',
          diffVal
        ].join(',');
      }).join('\n');

      const blob = new Blob([header + lines], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'inventory-compare.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    // Toast
    function showToast(message) {
      const container = $('#toaster');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = '<span class="toast-msg">' + escapeHTML(message) + '</span><button class="toast-close">\u00D7</button>';
      container.appendChild(toast);
      const remove = () => {
        toast.classList.add('removing');
        toast.addEventListener('animationend', () => toast.remove());
      };
      toast.querySelector('.toast-close').addEventListener('click', remove);
      setTimeout(remove, 5000);
    }

    // Debounce
    function debounce(fn, ms) {
      let timer;
      return function () {
        clearTimeout(timer);
        timer = setTimeout(fn, ms);
      };
    }

    // Event wiring
    $('#oldFiles').addEventListener('change', function () {
      handleFiles(this, oldData, $('#oldFileList'), $('#oldZone'));
    });

    $('#newFiles').addEventListener('change', function () {
      handleFiles(this, newData, $('#newFileList'), $('#newZone'));
    });

    $('#compareBtn').addEventListener('click', compareInventories);

    $('#filterListId').addEventListener('change', applyFilters);
    $('#filterInNew').addEventListener('change', applyFilters);
    $('#filterHasDiff').addEventListener('change', applyFilters);
    $('#filterSku').addEventListener('input', debounce(applyFilters, 200));

    $$('thead th').forEach(th => {
      th.addEventListener('click', () => handleSort(th.dataset.col));
    });

    $('#exportCsv').addEventListener('click', exportCSV);

    // Drag and drop
    ['oldZone', 'newZone'].forEach(id => {
      const zone = $('#' + id);
      zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
      zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
      zone.addEventListener('drop', e => {
        e.preventDefault();
        zone.classList.remove('dragover');
        const input = zone.querySelector('input[type="file"]');
        input.files = e.dataTransfer.files;
        input.dispatchEvent(new Event('change'));
      });
    });
  </script>
  <div id="toaster"></div>
</body>
</html>
